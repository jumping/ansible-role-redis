# This source file is subject to the (Open Source Initiative) BSD license
# that is bundled with this package in the LICENSE file. It is also available
# through the world-wide-web at this URL: http://www.ontic.com.au/license.html
# If you did not receive a copy of the license and are unable to obtain it through
# the world-wide-web, please send an email to license@ontic.com.au immediately.
# Copyright (c) 2010-2016 Ontic. (http://www.ontic.com.au). All rights reserved.

---

- name: Redis | Gather current system somaxconn setting.
  command: sysctl -n net.core.somaxconn
  register: sysctl_somaxconn

- name: Redis | Configure system somaxconn setting.
  sysctl:
    name: net.core.somaxconn
    value: 5
  when: sysctl_somaxconn.stdout | int < redis_tcp_backlog

- name: Redis | Configure Redis conf file.
  become: yes
  template:
    src: '{{ redis_conf_template }}'
    dest: '{{ redis_conf_file }}'
    owner: root
    group: root
    mode: 0644
  notify: restart redis
  when: redis_conf_template | default(None) != None